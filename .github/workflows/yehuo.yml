name: yehuo

on:
  schedule:
    - cron: '0 */6 * * *'          # 每 6 小时自动检查一次（凌晨/上午/下午/晚上各一次）
  workflow_dispatch:               # 允许手动触发测试

permissions:
  contents: write                  # 必须：允许 Actions 写仓库（commit/push）

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0           # 完整历史，便于 rebase 和 commit

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'   # 建议用 3.11（你的报错日志里是 3.11），或保持 '3.9'

      - name: Install dependencies
        run: pip install requests urllib3

      - name: Run script
        run: python check_sources.py   # ← 如果你的脚本叫 main.py，就改成 python main.py

      - name: Commit and Push if changed
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # 先 fetch 最新远程状态
          git fetch origin

          # 切换/确保在 master 分支（你的默认分支）
          git checkout master || git checkout -b master

          # rebase 远程 master，避免落后导致 rejected
          git rebase origin/master || { echo "Rebase 失败，可能有冲突，请检查仓库"; exit 1; }

          # 只检查 live_sources.m3u 是否有变化（你的脚本输出文件是这个）
          if [ -n "$(git status --porcelain live_sources.m3u)" ]; then
            git add live_sources.m3u cache.json   # 加 cache.json 一起提交（如果有变化）
            git commit -m "Auto update: live sources changed ($(date +'%Y-%m-%d %H:%M:%S'))"
            
            # 安全推送（--force-with-lease 防止意外覆盖别人，但允许覆盖自己落后）
            git push origin master --force-with-lease
            echo "已推送更新"
          else
            echo "live_sources.m3u 和 cache.json 无实质变化，跳过推送。"
          fi
